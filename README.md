# Telegram Web App Bot

Телеграм бот с веб-приложением для обработки и шаринга данных через Telegram Mini Apps.

## Требования

- Docker и Docker Compose
- Cloudflared (опционально, для создания туннеля)

## Структура проекта

```
├── services/
│   ├── backend/      # FastAPI бэкенд
│   ├── bot/          # Telegram бот
│   └── frontend/     # Vue.js фронтенд
├── config/
│   └── redis/        # Конфигурация Redis
│       └── redis.conf # Файл конфигурации Redis
├── docker-compose.yml
├── update_url.sh     # Скрипт для обновления URL
└── README.md
```

## Архитектура приложения

Приложение состоит из трех основных компонентов:

1. **Фронтенд (Vue.js)** - веб-приложение, которое открывается в Telegram Mini Apps
2. **Бэкенд (FastAPI)** - API для обработки запросов от фронтенда
3. **Бот (Aiogram)** - Telegram бот для взаимодействия с пользователем

Дополнительные компоненты:
- **Kafka** - система обмена сообщениями между сервисами
- **PostgreSQL** - база данных для хранения информации
- **Redis** - кэширование данных
- **Docker** - система контейнеризации для развертывания сервисов

## Настройка мини-приложения в BotFather

Для работы Telegram Mini App необходимо настроить его в BotFather:

1. Откройте @BotFather в Telegram
2. Отправьте команду `/mybots` и выберите вашего бота
3. Выберите "Bot Settings" > "Menu Button" > "Configure menu button"
4. Введите текст для кнопки (например, "Открыть приложение")
5. Введите URL вашего приложения (тот же, что указан в `EXTERNAL_URL`)
6. Для настройки мини-приложения отправьте команду `/newapp`
7. Выберите вашего бота
8. Введите название для мини-приложения (должно совпадать с `APP_NAME` в `services/backend/.env`)
9. Загрузите иконку для приложения (квадратное изображение)
10. Введите короткое описание приложения
11. Введите URL вашего приложения (тот же, что указан в `EXTERNAL_URL`)

После настройки BotFather предоставит вам ссылку на ваше мини-приложение вида:
```
https://t.me/ИмяБота/ИмяПриложения
```

## Запуск приложения

1. Настройте переменные окружения в файлах `.env`:

Создайте или отредактируйте следующие файлы:

**Корневой файл `.env`**:
```
# Настройки Telegram бота
BOT_TOKEN=ваш_токен_бота  # Получите у @BotFather

# Внешний URL приложения (обновляется скриптом update_url.sh)
EXTERNAL_URL=https://ваш_домен.com

```

**Файл `services/backend/.env`**:
```
BOT_TOKEN=ваш_токен_бота  # Тот же, что и в корневом .env
APP_NAME=название_вашего_мини_приложения
BOT_NAME=имя_вашего_бота_без_@
EXTERNAL_URL=https://ваш_домен.com
```

**Файл `services/bot/.env`**:
```
BOT_TOKEN=ваш_токен_бота  # Тот же, что и в корневом .env
EXTERNAL_URL=https://ваш_домен.com
```

### Вариант 1: Использование Cloudflared (быстрый способ для разработки)

2. Установите Cloudflare CLI (для пользования сервисом нужна авторизация):
```bash
brew install cloudflare/cloudflare/cloudflared
```
Вариант установки без homebrew:
```bash
curl -L https://github.com/cloudflare/cloudflared/releases/download/2024.03.0/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
```

3. Запустите контейнеры:
```bash
docker-compose up -d
```

4. Запустите скрипт для создания туннеля и обновления URL:
```bash
./update_url.sh
```
Этот скрипт:
- Создаст туннель Cloudflare и получит новый URL
- Обновит URL во всех `.env` файлах
- Предоставит инструкцию для обновить URL в BotFather
- Предложит перезапустить контейнеры с новым URL

4.1 Если скрипт не работает, то сделайте это в ручную:
```bash
cloudflared tunnel --url http://localhost:8080
```
Откройте файлы `.env`, `services/backend/.env`, `services/bot/.env` и обновите значение `EXTERNAL_URL` на новый URL.

4.2 Перезапустите контейнеры:
```bash
docker-compose down
docker-compose up -d
``` 

### Вариант 2: Альтернативные способы настройки (без Cloudflared)

Использование Cloudflared не является обязательным. Вы можете использовать любой другой способ для обеспечения доступа к вашему приложению из интернета:

1. **Настройка на собственном сервере**:
   - Разверните приложение на VPS или выделенном сервере с публичным IP
   - Настройте DNS для вашего домена, чтобы он указывал на ваш сервер
   - Настройте Nginx или другой веб-сервер для проксирования запросов к вашему приложению
   - Обязательно настройте SSL (например, с помощью Let's Encrypt)

2. **Использование других туннельных сервисов**:
   - Ngrok: `ngrok http 8080`
   - Localtunnel: `lt --port 8080`
   - Serveo: `ssh -R 80:localhost:8080 serveo.net`

3. **Использование облачных платформ**:
   - Heroku, Google Cloud Run, AWS Elastic Beanstalk и т.д.

Независимо от выбранного метода, вам необходимо:
1. Получить публичный URL для вашего приложения
2. Обновить значение `EXTERNAL_URL` в файлах `.env`, `services/backend/.env` и `services/bot/.env`
3. Обновить URL в BotFather для вашего мини-приложения
4. Перезапустить контейнеры, чтобы применить новые настройки

### Открытие приложения

После настройки URL и перезапуска контейнеров:
1. Откройте бота в Telegram
2. Отправьте команду `/start`
3. Бот ответит сообщением с кнопкой "Открыть приложение"
4. При нажатии на кнопку откроется веб-приложение

## Роль Kafka в приложении

Kafka используется для асинхронной коммуникации между сервисами:

1. **Обработка событий**:
   - `share_created` - когда пользователь создает новую шару (поделился данными)
   - `user_updated` - когда информация о пользователе обновляется
   - `send_message` - отправка сообщений боту с бекенда
   
2. **Уведомления пользователей**:
   - Бот получает события из Kafka и отправляет уведомления пользователям
   - Бэкенд не отправляет сообщения напрямую, а делегирует эту задачу боту

## Конфигурация Redis

Redis используется для кэширования данных в приложении. Основные настройки:

1. **Хранение данных**:
   - Данные сохраняются в режиме AOF (Append Only File) для надежности
   - Настроены снапшоты RDB для периодического сохранения данных

2. **Управление памятью**:
   - Максимальный объем памяти: 256MB
   - Политика вытеснения: LRU (Least Recently Used)
   - Автоматическая очистка устаревших данных

3. **Настройка производительности**:
   - Оптимизированы параметры для быстрого доступа к данным
   - Настроен мониторинг медленных запросов

Файл конфигурации находится в `config/redis/redis.conf` и может быть изменен для настройки Redis под конкретные требования.

## Важные замечания

При использовании Cloudflared:
- Каждый раз при перезапуске приложения нужно заново запускать `update_url.sh`, так как Cloudflare создает новый временный URL
- URL действителен только во время работы скрипта `update_url.sh`
- Если вы остановите скрипт `update_url.sh`, туннель закроется и приложение станет недоступным

При использовании альтернативных методов:
- Убедитесь, что ваш URL доступен из интернета и имеет действительный SSL-сертификат
- Telegram Mini Apps требуют HTTPS для работы
- При изменении URL не забудьте обновить его во всех `.env` файлах и в BotFather

## Остановка приложения

Для остановки всех контейнеров выполните:
```bash
docker-compose down
```

Не забудьте также остановить скрипт `update_url.sh` (Ctrl+C). 