# Telegram Web App Bot

Телеграм бот с веб-приложением для обработки и шаринга данных через Telegram Mini Apps.

## Требования

- Docker и Docker Compose
- Cloudflared (для создания туннеля)

## Структура проекта

```
├── services/
│   ├── backend/      # FastAPI бэкенд
│   ├── bot/          # Telegram бот
│   └── frontend/     # Vue.js фронтенд
├── config/
│   └── redis/        # Конфигурация Redis
│       └── redis.conf # Файл конфигурации Redis
├── docker-compose.yml
├── update_url.sh     # Скрипт для обновления URL
└── README.md
```

## Архитектура приложения

Приложение состоит из трех основных компонентов:

1. **Фронтенд (Vue.js)** - веб-приложение, которое открывается в Telegram Mini Apps
2. **Бэкенд (FastAPI)** - API для обработки запросов от фронтенда
3. **Бот (Aiogram)** - Telegram бот для взаимодействия с пользователем

Дополнительные компоненты:
- **Kafka** - система обмена сообщениями между сервисами
- **PostgreSQL** - база данных для хранения информации
- **Redis** - кэширование данных
- **Docker** - система контейнеризации для развертывания сервисов

## Запуск приложения

1. Добавьте BOT_TOKEN в файлы `.env`

2. Установите Cloudflare CLI (для пользования сервисом нужна авторизация):
```bash
brew install cloudflare/cloudflare/cloudflared
```
Вариант установки без homebrew:
```bash
curl -L https://github.com/cloudflare/cloudflared/releases/download/2024.03.0/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
```

3. Запустите контейнеры:
```bash
docker-compose up -d
```

4. Запустите скрипт для создания туннеля и обновления URL:
```bash
./update_url.sh
```
Этот скрипт:
- Создаст туннель Cloudflare и получит новый URL
- Обновит URL во всех `.env` файлах
- Предоставит инструкцию для обновить URL в BotFather
- Предложит перезапустить контейнеры с новым URL

4.1 Если скрипт не работает, то сделайте это в ручную:
```bash
cloudflared tunnel --url http://localhost:8080
```
Откройте файлы `.env`, `services/backend/.env`, `services/bot/.env` и обновите значение `EXTERNAL_URL` на новый URL.

4.2 Перезапустите контейнеры:
```bash
docker-compose down
docker-compose up -d
``` 

5. Откройте бота в Telegram:
- Отправьте команду `/start`
- Бот ответит сообщением с кнопкой "Открыть приложение"
- При нажатии на кнопку откроется веб-приложение

## Роль Kafka в приложении

Kafka используется для асинхронной коммуникации между сервисами:

1. **Обработка событий**:
   - `share_created` - когда пользователь создает новую шару (поделился данными)
   - `user_updated` - когда информация о пользователе обновляется

2. **Уведомления пользователей**:
   - Бот получает события из Kafka и отправляет уведомления пользователям
   - Бэкенд не отправляет сообщения напрямую, а делегирует эту задачу боту

## Конфигурация Redis

Redis используется для кэширования данных в приложении. Основные настройки:

1. **Хранение данных**:
   - Данные сохраняются в режиме AOF (Append Only File) для надежности
   - Настроены снапшоты RDB для периодического сохранения данных

2. **Управление памятью**:
   - Максимальный объем памяти: 256MB
   - Политика вытеснения: LRU (Least Recently Used)
   - Автоматическая очистка устаревших данных

3. **Настройка производительности**:
   - Оптимизированы параметры для быстрого доступа к данным
   - Настроен мониторинг медленных запросов

Файл конфигурации находится в `config/redis/redis.conf` и может быть изменен для настройки Redis под конкретные требования.

## Важные замечания

- Каждый раз при перезапуске приложения нужно заново запускать `update_url.sh`, так как Cloudflare создает новый временный URL
- URL действителен только во время работы скрипта `update_url.sh`
- Если вы остановите скрипт `update_url.sh`, туннель закроется и приложение станет недоступным


## Остановка приложения

Для остановки всех контейнеров выполните:
```bash
docker-compose down
```

Не забудьте также остановить скрипт `update_url.sh` (Ctrl+C). 